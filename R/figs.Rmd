---
title: "Random Grid"
subtitle: "Figs"
author: "L Kell & A Tidd"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---

```{r, knitr, eval=TRUE, echo=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(knitr)

opts_chunk$set(comment   =NA, 
               warning   =FALSE, 
               message   =FALSE, 
               error     =FALSE, 
               echo      =FALSE,
               fig.width =10, 
               fig.height=10,
               cache     =TRUE, 
               fig.path  ="../tex/rg-",
               cache.path="../cache/rg/")

iFig=0
iTab=0
```
```{r, dir}
dirMy=dirname(dirname(FLife:::getScriptPath()))
#dirMy="/home/laurence/Desktop/sea++/mydas/tasks/task4"
dirDat="/home/laurence/Desktop/Dropbox/mydasOMs/data"
dirRes="/home/laurence/Desktop/Dropbox/mydasOMs/results"
```
```{r, pkgs}
library(ggplot2)
library(plyr)
library(dplyr)
library(reshape)
library(GGally)

library(FLCore)
library(FLBRP)
library(FLasher)
library(ggplotFL)
library(FLife)
```

## Life history parameters

```{r, priors}
vonBFn=function(age,params){
  
  dimnames(params)[[1]]=tolower(dimnames(params)[[1]])
  
  res=params["linf"]%*%(1.0-exp((-params["k"])%*%(age%-%params["t0"])))
  
  dimnames(res)=dimnames(age)
  res}

load(file.path(dirDat,"brill.RData"))
prior=rbind(prior[-4],vonBFn(prior,age=prior["a50"]))
pr=cbind(spp="brill",model.frame(prior))

load(file.path(dirDat,"turbot.RData"))
prior=rbind(prior[-4],vonBFn(prior,age=prior["a50"]))
pr=rbind.fill(pr,cbind(spp="turbot",model.frame(prior)))

load(file.path(dirDat,"ray.RData"))
prior=rbind(prior[-4],vonBFn(prior,age=prior["a50"]))
pr=rbind.fill(pr,cbind(spp="ray",model.frame(prior)))

load(file.path(dirDat,"pollack.RData"))
prior=rbind(prior[-4],vonBFn(prior,age=prior["a50"]))
pr=rbind.fill(pr,cbind(spp="pollack",model.frame(prior)))

load(file.path(dirDat,"sprat.RData"))
prior=rbind(prior[-4],vonBFn(prior,age=prior["a50"]))
pr=rbind.fill(pr,cbind(spp="sprat",model.frame(prior)))
names(pr)[22]="l50"

params=pr
rm(pr)  

k=ddply(params,.(spp), with, mean(k))
ord=ac(k[order(k$V1),"spp"])
params$spp=factor(params$spp,levels=ord)
save(params,file="/home/laurence/Desktop/sea++/mydas/project/papers/randomGrid/data/params.RData")
```


```{r, lhpar, fig.height=3}
ggplot(transform(melt(params[,c("spp","linf","k","l50")]),  
                 variable=factor(variable,level=c("k","linf","l50"))))+
  geom_boxplot(aes(spp,value))+facet_wrap(~variable,scale="free")
```

**Figure `r iFig=iFig+1; iFig`** Life history parameters.


```{r, derived, fig.height=8}
ggplot(transform(melt(params[,c("spp","spr0","lopt","r","rc","fm","mk","bmsy","fmsy","msy")]),
                 variable=factor(variable,
                          level=c("r","rc","spr0","lopt","fm","mk","bmsy","fmsy","msy"))))+
  geom_boxplot(aes(spp,value))+facet_wrap(~variable,scale="free")
```

**Figure `r iFig=iFig+1; iFig`** Reference points.


## Equilibrium dynamics

The parameters are then used by `lhEql` to simulate the equilibrium dynamics by combining the spawner/yield per recruit relationships with a stock recruiment relationship.

```{r, eqRun}
eq=lhEql(lh,spwn=0)
```


```{r vectors}
sel<-function(x) 
  catch.sel(x)%/%fapex(catch.sel(x))

len<-function(x)
  (stock.wt(x)%^%(1/lh["b"]))

load(file.path(dirDat,"brill.RData"))
dat=FLQuants(eq,"M"=m,"Selectivity"=sel,"Maturity"=mat,"Length"=len)
vct=cbind(spp="brill",as.data.frame(FLQuants(eq,"M"=m,"Selectivity"=sel,"Maturity"=mat,"Length"=len)))

load(file.path(dirDat,"turbot.RData"))
dat=FLQuants(eq,"M"=m,"Selectivity"=sel,"Maturity"=mat,"Length"=len)
dat=cbind(spp="turbot",as.data.frame(FLQuants(eq,"M"=m,"Selectivity"=sel,"Maturity"=mat,"Length"=len)))
vct=rbind(vct,dat)

load(file.path(dirDat,"ray.RData"))
dat=FLQuants(eq,"M"=m,"Selectivity"=sel,"Maturity"=mat,"Length"=len)
dat=cbind(spp="ray",as.data.frame(FLQuants(eq,"M"=m,"Selectivity"=sel,"Maturity"=mat,"Length"=len)))
vct=rbind(vct,dat)

load(file.path(dirDat,"pollack.RData"))
dat=FLQuants(eq,"M"=m,"Selectivity"=sel,"Maturity"=mat,"Length"=len)
dat=cbind(spp="pollack",as.data.frame(FLQuants(eq,"M"=m,"Selectivity"=sel,"Maturity"=mat,"Length"=len)))
vct=rbind(vct,dat)

load(file.path(dirDat,"sprat.RData"))
dat=cbind(spp="sprat",as.data.frame(FLQuants(eq,"M"=m,"Selectivity"=sel,"Maturity"=mat,"Length"=len)))
vct=rbind(vct,dat)

vct=ddply(vct,.(spp,age,qname),with, quantile(data))
     
ggplot(subset(vct,age<=10))+
  geom_ribbon(aes(age,ymax=`75%`,ymin=`25%`,col=spp,fill=spp),alpha=0.2)+
  geom_line(aes(age,`50%`,col=spp))+
  facet_wrap(~qname,scale="free")+
  scale_x_continuous(limits=c(0,10))+
  xlab("Age")+ylab("")+
  theme(legend.position="bottom")
```

**Figure `r iFig=iFig+1; iFig`** Vectors.


```{r, eq}
load(file.path(dirDat,"turbot.RData"))

plot(iter(eq,1),refpts=FALSE)  
```

**Figure `r iFig=iFig+1; iFig`** Equilibrum Curves.

## Population dynamics

```{r ts}
load(file.path(dirDat,"turbot.RData"))

dat=FLQuants(window(om,start=10,end=60), 
          "ssb" = function(x) ssb(x)%/%refpts( eq)["msy","ssb"], 
          "f" =   function(x) fbar(x)%/%refpts(eq)["msy","harvest"], 
          "rec" = function(x) rec(x)%/%refpts( eq)["msy","rec"], 
          "catch"=function(x) landings(x)%/%refpts(eq)["msy","yield"])
plot(dat)
```

**Figure `r iFig=iFig+1; iFig`** Time series relative to MSY benchmarks.

\newpage
## Software Versions

* `r version$version.string`
* FLCore:    `r packageVersion('FLCore')`
* FLBRP:     `r packageVersion('FLBRP')`
* FLasher:   `r packageVersion('FLasher')`
* FLife:     `r packageVersion('FLife')`
* ggplotFL:  `r packageVersion('ggplotFL')`
* **Compiled**: `r date()`

## Author information

**Laurence Kell**. laurie@seaplusplus.es

## Acknowledgements

This vignette and many of the methods documented in it were developed under the MyDas project funded by the Irish exchequer and EMFF 2014-2020. The overall aim of MyDas is to develop and test a range of assessment models and methods to establish Maximum Sustainable Yield (MSY) reference points (or proxy MSY reference points) across the spectrum of data-limited stocks.

# References {#References}

\newpage
# Session Info

```{r}
sessionInfo()
```

